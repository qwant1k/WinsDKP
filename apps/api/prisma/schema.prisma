generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ──────────────────────────────────────────────────

enum GlobalRole {
  PORTAL_ADMIN
  USER
}

enum ClanRole {
  CLAN_LEADER
  ELDER
  MEMBER
  NEWBIE
}

enum ClanJoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DkpTransactionType {
  ACTIVITY_REWARD
  AUCTION_WIN
  AUCTION_REFUND
  PENALTY
  ADMIN_ADJUST
  HOLD_PLACE
  HOLD_RELEASE
  HOLD_FINALIZE
  MANUAL_CREDIT
  MANUAL_DEBIT
}

enum DkpHoldStatus {
  ACTIVE
  FINALIZED
  RELEASED
}

enum ActivityStatus {
  DRAFT
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ActivityType {
  RAID
  EXPEDITION
  DUNGEON
  PVP
  GUILD_WAR
  WORLD_BOSS
  OTHER
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum LotStatus {
  PENDING
  ACTIVE
  SOLD
  UNSOLD
  CANCELLED
}

enum RandomizerStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ItemRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
  MYTHIC
}

enum WarehouseMovementType {
  INCOMING
  OUTGOING_AUCTION
  OUTGOING_RANDOMIZER
  RETURN
  WRITE_OFF
}

enum NotificationType {
  DKP_RECEIVED
  DKP_PENALTY
  AUCTION_OUTBID
  AUCTION_WON
  AUCTION_LOST
  AUCTION_STARTED
  RANDOMIZER_WON
  RANDOMIZER_STARTED
  ACTIVITY_CREATED
  ACTIVITY_STARTED
  ACTIVITY_COMPLETED
  CLAN_JOIN_REQUEST
  CLAN_JOIN_APPROVED
  CLAN_JOIN_REJECTED
  CLAN_ROLE_CHANGED
  CLAN_KICKED
  NEWS_POSTED
  COMMENT_REPLY
  MESSAGE_RECEIVED
  SYSTEM
}

enum MediaEntityType {
  NEWS_POST
  FEED_POST
  COMMENT
  WAREHOUSE_ITEM
  USER_AVATAR
}

// ─── USERS & AUTH ───────────────────────────────────────────

model User {
  id            String     @id @default(uuid()) @db.Uuid
  email         String     @unique
  passwordHash  String?    @map("password_hash")
  globalRole    GlobalRole @default(USER) @map("global_role")
  emailVerified Boolean    @default(false) @map("email_verified")
  emailToken    String?    @map("email_token")
  resetToken    String?    @map("reset_token")
  resetTokenExp DateTime?  @map("reset_token_exp")
  isActive      Boolean    @default(true) @map("is_active")
  deletedAt     DateTime?  @map("deleted_at")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  profile         Profile?
  socialAccounts  SocialAccount[]
  sessions        Session[]
  clanMemberships ClanMembership[]
  joinRequests    ClanJoinRequest[]
  dkpWallet       DkpWallet?
  dkpTransactions DkpTransaction[]
  dkpHolds        DkpHold[]
  penalties       Penalty[]
  activityParticipations ActivityParticipant[]
  bids            Bid[]
  auctionParticipations AuctionParticipant[]
  auctionChatMessages AuctionChatMessage[]
  randomizerEntries RandomizerEntry[]
  newsPosts       NewsPost[]
  feedPosts       FeedPost[]
  comments        Comment[]
  reactions       Reaction[]
  notifications   Notification[]
  auditLogs       AuditLog[]       @relation("AuditActor")
  mediaAttachments MediaAttachment[]
  sentMessages     DirectMessage[]  @relation("MessageSender")
  receivedMessages DirectMessage[]  @relation("MessageReceiver")

  @@map("users")
}

model Profile {
  id          String  @id @default(uuid()) @db.Uuid
  userId      String  @unique @map("user_id") @db.Uuid
  nickname    String  @unique
  displayName String? @map("display_name")
  bm          Int     @default(0)
  level       Int     @default(1)
  avatarUrl   String? @map("avatar_url")
  contacts    Json?   @default("{}")
  locale      String  @default("ru")
  timezone    String  @default("Asia/Almaty")
  notifyPrefs Json?   @default("{}") @map("notify_prefs")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model SocialAccount {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  provider   String
  providerId String   @map("provider_id")
  email      String?
  avatar     String?
  raw        Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@map("social_accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  refreshToken String   @map("refresh_token")
  userAgent    String?  @map("user_agent")
  ip           String?
  expiresAt    DateTime @map("expires_at")
  revokedAt    DateTime? @map("revoked_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

// ─── CLANS ──────────────────────────────────────────────────

model Clan {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  tag         String   @unique
  description String?
  avatarUrl   String?  @map("avatar_url")
  isActive    Boolean  @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  memberships  ClanMembership[]
  joinRequests ClanJoinRequest[]
  activities   Activity[]
  auctions     Auction[]
  warehouseItems WarehouseItem[]
  randomizerSessions RandomizerSession[]
  newsPosts    NewsPost[]
  feedPosts    FeedPost[]

  @@map("clans")
}

model ClanMembership {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  clanId    String   @map("clan_id") @db.Uuid
  role      ClanRole @default(NEWBIE)
  joinedAt  DateTime @default(now()) @map("joined_at")
  leftAt    DateTime? @map("left_at")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@unique([userId, clanId])
  @@index([clanId])
  @@map("clan_memberships")
}

model ClanJoinRequest {
  id        String               @id @default(uuid()) @db.Uuid
  userId    String               @map("user_id") @db.Uuid
  clanId    String               @map("clan_id") @db.Uuid
  status    ClanJoinRequestStatus @default(PENDING)
  message   String?
  reviewedBy String?             @map("reviewed_by") @db.Uuid
  reviewedAt DateTime?           @map("reviewed_at")
  createdAt DateTime             @default(now()) @map("created_at")
  updatedAt DateTime             @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  clan Clan @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@index([clanId, status])
  @@map("clan_join_requests")
}

// ─── DKP ECONOMY ────────────────────────────────────────────

model DkpWallet {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  balance   Decimal  @default(0) @db.Decimal(12, 2)
  onHold    Decimal  @default(0) @map("on_hold") @db.Decimal(12, 2)
  totalEarned Decimal @default(0) @map("total_earned") @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("dkp_wallets")
}

model DkpTransaction {
  id             String            @id @default(uuid()) @db.Uuid
  userId         String            @map("user_id") @db.Uuid
  type           DkpTransactionType
  amount         Decimal           @db.Decimal(12, 2)
  balanceBefore  Decimal           @map("balance_before") @db.Decimal(12, 2)
  balanceAfter   Decimal           @map("balance_after") @db.Decimal(12, 2)
  description    String?
  referenceType  String?           @map("reference_type")
  referenceId    String?           @map("reference_id") @db.Uuid
  idempotencyKey String?           @unique @map("idempotency_key")
  metadata       Json?
  createdAt      DateTime          @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([referenceType, referenceId])
  @@map("dkp_transactions")
}

model DkpHold {
  id          String        @id @default(uuid()) @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  amount      Decimal       @db.Decimal(12, 2)
  status      DkpHoldStatus @default(ACTIVE)
  reason      String?
  referenceType String?     @map("reference_type")
  referenceId String?       @map("reference_id") @db.Uuid
  finalizedAt DateTime?     @map("finalized_at")
  releasedAt  DateTime?     @map("released_at")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@map("dkp_holds")
}

model Penalty {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  amount      Decimal  @db.Decimal(12, 2)
  reason      String
  issuedBy    String   @map("issued_by") @db.Uuid
  clanId      String   @map("clan_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("penalties")
}

// ─── ACTIVITIES ─────────────────────────────────────────────

model Activity {
  id          String         @id @default(uuid()) @db.Uuid
  clanId      String         @map("clan_id") @db.Uuid
  type        ActivityType
  title       String
  description String?
  baseDkp     Decimal        @map("base_dkp") @db.Decimal(12, 2)
  startAt     DateTime?      @map("start_at")
  endAt       DateTime?      @map("end_at")
  status      ActivityStatus @default(DRAFT)
  createdBy   String         @map("created_by") @db.Uuid
  deletedAt   DateTime?      @map("deleted_at")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  clan         Clan                  @relation(fields: [clanId], references: [id], onDelete: Cascade)
  participants ActivityParticipant[]
  logs         ActivityLog[]

  @@index([clanId, status])
  @@map("activities")
}

model ActivityParticipant {
  id          String    @id @default(uuid()) @db.Uuid
  activityId  String    @map("activity_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  dkpEarned   Decimal?  @map("dkp_earned") @db.Decimal(12, 2)
  joinedAt    DateTime  @default(now()) @map("joined_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([activityId, userId])
  @@map("activity_participants")
}

model ActivityLog {
  id         String   @id @default(uuid()) @db.Uuid
  activityId String   @map("activity_id") @db.Uuid
  action     String
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model CoefficientPowerRange {
  id          String   @id @default(uuid()) @db.Uuid
  clanId      String   @map("clan_id") @db.Uuid
  fromPower   Int      @map("from_power")
  toPower     Int      @map("to_power")
  coefficient Decimal  @db.Decimal(5, 3)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([clanId])
  @@map("coefficient_power_ranges")
}

model CoefficientLevelRange {
  id          String   @id @default(uuid()) @db.Uuid
  clanId      String   @map("clan_id") @db.Uuid
  fromLevel   Int      @map("from_level")
  toLevel     Int      @map("to_level")
  coefficient Decimal  @db.Decimal(5, 3)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([clanId])
  @@map("coefficient_level_ranges")
}

// ─── WAREHOUSE ──────────────────────────────────────────────

model WarehouseItem {
  id          String     @id @default(uuid()) @db.Uuid
  clanId      String     @map("clan_id") @db.Uuid
  name        String
  description String?
  quantity    Int        @default(0)
  rarity      ItemRarity @default(COMMON)
  imageUrl    String?    @map("image_url")
  dkpPrice    Decimal?   @map("dkp_price") @db.Decimal(12, 2)
  source      String?
  deletedAt   DateTime?  @map("deleted_at")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  clan      Clan                    @relation(fields: [clanId], references: [id], onDelete: Cascade)
  movements WarehouseItemMovement[]
  lots      Lot[]

  @@index([clanId])
  @@map("warehouse_items")
}

model WarehouseItemMovement {
  id        String                @id @default(uuid()) @db.Uuid
  itemId    String                @map("item_id") @db.Uuid
  type      WarehouseMovementType
  quantity  Int
  reason    String?
  performedBy String              @map("performed_by") @db.Uuid
  referenceType String?           @map("reference_type")
  referenceId String?             @map("reference_id") @db.Uuid
  createdAt DateTime              @default(now()) @map("created_at")

  item WarehouseItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("warehouse_item_movements")
}

// ─── AUCTIONS ───────────────────────────────────────────────

model Auction {
  id                  String        @id @default(uuid()) @db.Uuid
  clanId              String        @map("clan_id") @db.Uuid
  title               String
  description         String?
  status              AuctionStatus @default(DRAFT)
  startAt             DateTime?     @map("start_at")
  endAt               DateTime?     @map("end_at")
  antiSniperEnabled   Boolean       @default(true) @map("anti_sniper_enabled")
  antiSniperSeconds   Int           @default(20) @map("anti_sniper_seconds")
  antiSniperExtendSec Int           @default(30) @map("anti_sniper_extend_sec")
  createdBy           String        @map("created_by") @db.Uuid
  deletedAt           DateTime?     @map("deleted_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  clan         Clan                 @relation(fields: [clanId], references: [id], onDelete: Cascade)
  lots         Lot[]
  participants AuctionParticipant[]
  chatMessages AuctionChatMessage[]
  systemEvents AuctionSystemEvent[]

  @@index([clanId, status])
  @@map("auctions")
}

model Lot {
  id              String    @id @default(uuid()) @db.Uuid
  auctionId       String    @map("auction_id") @db.Uuid
  warehouseItemId String    @map("warehouse_item_id") @db.Uuid
  quantity        Int       @default(1)
  startPrice      Decimal   @map("start_price") @db.Decimal(12, 2)
  minStep         Decimal   @default(1) @map("min_step") @db.Decimal(12, 2)
  currentPrice    Decimal?  @map("current_price") @db.Decimal(12, 2)
  status          LotStatus @default(PENDING)
  endsAt          DateTime? @map("ends_at")
  sortOrder       Int       @default(0) @map("sort_order")
  winnerId        String?   @map("winner_id") @db.Uuid
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  auction       Auction       @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  warehouseItem WarehouseItem @relation(fields: [warehouseItemId], references: [id])
  bids          Bid[]
  result        LotResult?

  @@index([auctionId, status])
  @@map("lots")
}

model AuctionParticipant {
  id        String   @id @default(uuid()) @db.Uuid
  auctionId String   @map("auction_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  joinedAt  DateTime @default(now()) @map("joined_at")

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([auctionId, userId])
  @@map("auction_participants")
}

model Bid {
  id             String   @id @default(uuid()) @db.Uuid
  lotId          String   @map("lot_id") @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  amount         Decimal  @db.Decimal(12, 2)
  isAutoBid      Boolean  @default(false) @map("is_auto_bid")
  maxAutoBid     Decimal? @map("max_auto_bid") @db.Decimal(12, 2)
  holdId         String?  @map("hold_id") @db.Uuid
  idempotencyKey String?  @unique @map("idempotency_key")
  createdAt      DateTime @default(now()) @map("created_at")

  lot  Lot  @relation(fields: [lotId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lotId, createdAt])
  @@index([userId])
  @@map("bids")
}

model LotResult {
  id         String   @id @default(uuid()) @db.Uuid
  lotId      String   @unique @map("lot_id") @db.Uuid
  winnerId   String?  @map("winner_id") @db.Uuid
  finalPrice Decimal? @map("final_price") @db.Decimal(12, 2)
  status     String
  createdAt  DateTime @default(now()) @map("created_at")

  lot Lot @relation(fields: [lotId], references: [id], onDelete: Cascade)

  @@map("lot_results")
}

model AuctionChatMessage {
  id        String   @id @default(uuid()) @db.Uuid
  auctionId String   @map("auction_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  message   String
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime @default(now()) @map("created_at")

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([auctionId, createdAt])
  @@map("auction_chat_messages")
}

model AuctionSystemEvent {
  id        String   @id @default(uuid()) @db.Uuid
  auctionId String   @map("auction_id") @db.Uuid
  event     String
  data      Json?
  createdAt DateTime @default(now()) @map("created_at")

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId, createdAt])
  @@map("auction_system_events")
}

// ─── RANDOMIZER ─────────────────────────────────────────────

model RandomizerSession {
  id               String           @id @default(uuid()) @db.Uuid
  clanId           String           @map("clan_id") @db.Uuid
  warehouseItemId  String           @map("warehouse_item_id") @db.Uuid
  status           RandomizerStatus @default(PENDING)
  seed             String
  seedHash         String           @map("seed_hash")
  algorithmVersion String           @default("v1") @map("algorithm_version")
  inputData        Json             @map("input_data")
  createdBy        String           @map("created_by") @db.Uuid
  idempotencyKey   String?          @unique @map("idempotency_key")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  clan    Clan               @relation(fields: [clanId], references: [id], onDelete: Cascade)
  entries RandomizerEntry[]
  result  RandomizerResult?

  @@index([clanId])
  @@map("randomizer_sessions")
}

model RandomizerEntry {
  id        String   @id @default(uuid()) @db.Uuid
  sessionId String   @map("session_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  weight    Decimal  @db.Decimal(8, 5)
  bonus     Decimal  @db.Decimal(8, 5)
  createdAt DateTime @default(now()) @map("created_at")

  session RandomizerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@map("randomizer_entries")
}

model RandomizerResult {
  id        String   @id @default(uuid()) @db.Uuid
  sessionId String   @unique @map("session_id") @db.Uuid
  winnerId  String   @map("winner_id") @db.Uuid
  rollValue Decimal  @map("roll_value") @db.Decimal(12, 8)
  proof     Json
  createdAt DateTime @default(now()) @map("created_at")

  session RandomizerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("randomizer_results")
}

// ─── SOCIAL (NEWS / FEED) ──────────────────────────────────

model NewsPost {
  id        String    @id @default(uuid()) @db.Uuid
  clanId    String    @map("clan_id") @db.Uuid
  authorId  String    @map("author_id") @db.Uuid
  title     String
  content   String
  isPinned  Boolean   @default(false) @map("is_pinned")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  clan     Clan       @relation(fields: [clanId], references: [id], onDelete: Cascade)
  author   User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments Comment[]
  reactions Reaction[]

  @@index([clanId, createdAt])
  @@map("news_posts")
}

model FeedPost {
  id        String    @id @default(uuid()) @db.Uuid
  clanId    String    @map("clan_id") @db.Uuid
  authorId  String    @map("author_id") @db.Uuid
  content   String
  isReported Boolean  @default(false) @map("is_reported")
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  clan     Clan       @relation(fields: [clanId], references: [id], onDelete: Cascade)
  author   User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments Comment[]
  reactions Reaction[]

  @@index([clanId, createdAt])
  @@map("feed_posts")
}

model Comment {
  id         String    @id @default(uuid()) @db.Uuid
  authorId   String    @map("author_id") @db.Uuid
  content    String
  newsPostId String?   @map("news_post_id") @db.Uuid
  feedPostId String?   @map("feed_post_id") @db.Uuid
  parentId   String?   @map("parent_id") @db.Uuid
  isHidden   Boolean   @default(false) @map("is_hidden")
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  author   User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  newsPost NewsPost?  @relation(fields: [newsPostId], references: [id], onDelete: Cascade)
  feedPost FeedPost?  @relation(fields: [feedPostId], references: [id], onDelete: Cascade)
  parent   Comment?   @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[]  @relation("CommentReplies")
  reactions Reaction[]

  @@index([newsPostId])
  @@index([feedPostId])
  @@map("comments")
}

model Reaction {
  id         String  @id @default(uuid()) @db.Uuid
  userId     String  @map("user_id") @db.Uuid
  emoji      String
  newsPostId String? @map("news_post_id") @db.Uuid
  feedPostId String? @map("feed_post_id") @db.Uuid
  commentId  String? @map("comment_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  newsPost NewsPost? @relation(fields: [newsPostId], references: [id], onDelete: Cascade)
  feedPost FeedPost? @relation(fields: [feedPostId], references: [id], onDelete: Cascade)
  comment  Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, newsPostId, emoji])
  @@unique([userId, feedPostId, emoji])
  @@unique([userId, commentId, emoji])
  @@map("reactions")
}

// ─── NOTIFICATIONS ──────────────────────────────────────────

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  body      String?
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

// ─── AUDIT ──────────────────────────────────────────────────

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  actorId     String?  @map("actor_id") @db.Uuid
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id") @db.Uuid
  before      Json?
  after       Json?
  ip          String?
  userAgent   String?  @map("user_agent")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")

  actor User? @relation("AuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ─── AUDIT EVENT LOGS (per entity, human-readable) ─────────

model AuditEventLog {
  id          String   @id @default(uuid()) @db.Uuid
  actorId     String?  @map("actor_id") @db.Uuid
  actorName   String?  @map("actor_name")
  category    String
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id") @db.Uuid
  entityName  String?  @map("entity_name")
  description String
  details     Json?
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([category, createdAt])
  @@index([actorId, createdAt])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_event_logs")
}

// ─── MEDIA ──────────────────────────────────────────────────

model MediaAttachment {
  id         String          @id @default(uuid()) @db.Uuid
  uploaderId String          @map("uploader_id") @db.Uuid
  entityType MediaEntityType @map("entity_type")
  entityId   String          @map("entity_id") @db.Uuid
  filename   String
  mimeType   String          @map("mime_type")
  size       Int
  url        String
  createdAt  DateTime        @default(now()) @map("created_at")

  uploader User @relation(fields: [uploaderId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@map("media_attachments")
}

// ─── DIRECT MESSAGES ────────────────────────────────────────

model DirectMessage {
  id         String    @id @default(uuid()) @db.Uuid
  senderId   String    @map("sender_id") @db.Uuid
  receiverId String    @map("receiver_id") @db.Uuid
  content    String
  isRead     Boolean   @default(false) @map("is_read")
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  sender   User @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, isRead])
  @@map("direct_messages")
}

// ─── SYSTEM SETTINGS ────────────────────────────────────────

model SystemSetting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  value     Json
  group     String   @default("general")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
